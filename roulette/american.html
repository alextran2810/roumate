<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>American Roulette</title>
  <link rel="stylesheet" href="roulette.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="roulette-storage.js"></script>  

  <script src="roulette-template.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- App Header -->
<header class="app-header">
  <button class="icon-btn" id="btnAccount" title="Account (Home)">
    <img src="logo.png" alt="RouMate Logo" style="width: 32px; height: 32px; border-radius: 4px;">
  </button>
  <h1 class="app-title">RouMate</h1>
  <button class="icon-btn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
</header>

<!-- Account / Auth Dialog -->
<dialog id="accountDialog" class="dialog">
  <h3>Account</h3>

  <!-- If signed OUT: show sign in/up -->
  <div id="authPanel">
    <p>You are already signed in with phone authentication</p>
    
    <!-- Subscription Information -->
    <div class="subscription-info" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px; padding: 16px; margin: 16px 0; color: #065f46;">
      <div class="status" style="font-weight: bold; font-size: 18px; margin-bottom: 8px;" id="subscriptionStatus">
        Free Subscription
      </div>
      <div class="details" style="font-size: 14px; opacity: 0.8;" id="subscriptionDetails">
        10 spins remaining
      </div>
      <button id="btnManageSubscription" style="width: 100%; padding: 10px; margin-top: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
        Manage Subscription
      </button>
    </div>
    
    <div class="account-actions" style="margin-top: 16px;">
      <button id="btnSignOut" class="danger" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
        Sign out
      </button>
    </div>
  </div>

  <!-- If signed IN: show profile -->
  <div id="profilePanel" hidden>
    <div class="profile-grid">
      <div class="col-span-2">
        <label>Phone</label>
        <input id="pfPhone" disabled />
      </div>
    </div>
    
    <!-- Subscription Information for Profile Panel -->
    <div class="subscription-info" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px; padding: 16px; margin: 16px 0; color: #065f46;">
      <div class="status" style="font-weight: bold; font-size: 18px; margin-bottom: 8px;" id="subscriptionStatusProfile">
        Free Subscription
      </div>
      <div class="details" style="font-size: 14px; opacity: 0.8;" id="subscriptionDetailsProfile">
        10 spins remaining
      </div>
      <button id="btnManageSubscriptionProfile" style="width: 100%; padding: 10px; margin-top: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
        Manage Subscription
      </button>
    </div>
    
    <div class="account-actions">
      <span class="flex-grow"></span>
      <button id="btnSignOutProfile" class="danger" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
        Sign out
      </button>
    </div>
  </div>

  <div class="dialog-actions center">
    <button data-close-dialog>Close</button>
  </div>
</dialog>

<!-- Settings Dialog -->

<dialog id="settingsDialog" class="dialog">
  <h3>Settings</h3>

  <div class="setting-row setting-variant left">
    <span class="switch-side">European</span>
    <label class="switch">
      <input type="checkbox" id="toggleVariant" />
      <span class="slider"></span>
    </label>
    <span class="switch-side">American</span>
  </div>

  <div class="setting-row">
    <label class="switch">
      <input type="checkbox" id="toggleHideHelp" />
      <span class="slider"></span>
      <span class="switch-label">Hide help question marks</span>
    </label>
  </div>

  <div class="setting-row">
    <label class="switch">
      <input type="checkbox" id="toggleBarHighlight" checked />
      <span class="slider"></span>
      <span class="switch-label">Highlight bar segments</span>
    </label>
  </div>

  <div class="setting-row">
    <label class="switch">
      <input type="checkbox" id="toggleHeatmapHighlight" checked />
      <span class="slider"></span>
      <span class="switch-label">Highlight heatmap numbers</span>
    </label>
  </div>

  <div class="setting-group">
    <div class="setting-row-left">
      <label class="theme-label">Theme</label>
      <select id="themeSelector" class="theme-select">
        <option value="default">Default</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>

    <div class="setting-row-left">
      <label class="theme-label">Text Size</label>
      <div class="text-size-control">
        <button id="btnTextSizeDown" class="text-size-btn">A-</button>
        <input type="range" id="textScale" min="75" max="110" value="100" style="flex: 1; margin: 0 10px; width: 60px;" />
        <button id="btnTextSizeUp" class="text-size-btn">A+</button>
      </div>
    </div>
  </div>

  <div class="setting-row">
    </div>

  <div class="dialog-actions center">
    <button data-close-dialog>Done</button>
  </div>
</dialog>


<!-- Reusable Help Dialog -->
<dialog id="helpDialog" class="dialog">
  <h3 id="helpTitle">Help</h3>
  <div id="helpBody" class="help-body"></div>
  <div class="dialog-actions center">
    <button data-close-dialog>Close</button>
  </div>
</dialog>

<!-- Board Image Dialog -->
<dialog id="boardDialog" class="dialog board-dialog">
  <img id="boardImg" src="roulette_board.jpg" alt="Roulette Board" />
  <div class="dialog-actions center">
    <button data-close-dialog>Close</button>
  </div>
</dialog>

<!-- Confirmation Dialog -->
<dialog id="confirmDialog" class="dialog">
  <h3 id="confirmTitle">Confirm</h3>
  <p id="confirmMessage">Are you sure?</p>
  <div class="dialog-actions center">
    <button id="confirmOk" class="primary">OK</button>
    <button id="confirmCancel">Cancel</button>
  </div>
</dialog>


  <div class="top-section">
    <h1>American Roulette</h1>
    <div class="main-center">
      <div class="history-container">
        <div class="history-log empty" id="historyLog"></div>
      </div>

      <div class="numpad-and-buttons">
        <div class="numpad-container" id="numpad"></div>
      </div>

      <div class="stats-header">
        <h3><span class="help-qs" data-help="statistics">?</span> Statistics (last <span id="sliderValue">0</span> out of <span class="totalCount">0</span> total)</h3>
        <input type="range" id="rangeSlider" min="0" value="0" />
      </div>
    </div>
  </div>

  <div class="scroll-section">
    <div class="stats">
      <div class="bar-container" id="colBar"></div>
      <div class="bar-container" id="dozenBar"></div>

      <div class="chart-block">
        <div class="bar-container" id="halfBar"></div>
        <canvas id="halfChart" width="400" height="200"></canvas>
      </div>

      <div class="chart-block">
        <div class="bar-container" id="colorBar"></div>
        <canvas id="colorChart" width="400" height="200"></canvas>
      </div>

      <div class="chart-block">
        <div class="bar-container" id="parityBar"></div>
        <canvas id="parityChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div class="more-section" >
      <h3>Number Frequency Heatmap</h3>
      <div class="number-grid" id="plainGrid"></div>

      <div class="chart-block">
        <canvas id="freqChart" width="400" height="200"></canvas>

        <div class="separator"></div>

        <table class="combo-table">
          <thead>
            <tr>
              <th>Combination</th>
              <th>Spins Ago</th>
            </tr>
          </thead>
          <tbody id="comboBody"></tbody>
        </table>
      </div>
      <!-- Add this right after the Combination table -->
<h3>Longest & Current Streaks</h3>
<table class="streak-table">
  <thead>
    <tr>
      <th>Group</th>
      <th>Longest Streak</th>
      <th>Current Streak</th>
    </tr>
  </thead>
  <tbody id="streakBody"></tbody>
</table>


    </div>
  </div>

  <!-- Fixed footer buttons -->
  <div class="special-buttons">
    <button class="btn-reset" onclick="resetAll()">Reset</button>
    <button class="btn-view" onclick="toggleView()">üîÑ Keypad</button>
    <button class="btn-voice" onclick="toggleListening()">Voice Input</button>
    <button class="btn-test" onclick="openTestDialog()">Run Test</button>
  </div>

  <!-- Test dialog -->
  <div id="testDialog" class="dialog-overlay" style="display:none;">
    <div class="dialog-content">
      <h3>Run Test Simulation</h3>
      <p>Enter how many random spins to simulate (max 5000):</p>

      <input id="testCount" type="number" min="1" max="5000" step="1" placeholder="e.g. 100"
             style="width:90%; padding:6px;"
             oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(parseInt(this.value) > 5000) this.value = 5000;" />

      <div style="margin-top:10px;">History action:</div>
      <div style="margin:8px 0;">
        <label style="display:block; margin:4px 0;">
          <input type="radio" name="historyAction" value="reset" checked /> Reset history before test
        </label>
        <label style="display:block; margin:4px 0;">
          <input type="radio" name="historyAction" value="continue" /> Continue from current history
        </label>
      </div>

      <div style="margin-top:10px;">Choose speed:</div>
      <select id="speedSelect" style="width:90%; padding:6px; margin:8px 0;">
        <option value="fast">‚ö° Faster</option>
        <option value="regular" selected>‚è± Regular</option>
        <option value="slow">üê¢ Slower</option>
      </select>

      <div class="dialog-actions" style="margin-top:10px; text-align:right;">
        <button onclick="startTest()">Start</button>
        <button onclick="closeTestDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Language dialog -->
  <div id="langDialog" class="dialog-overlay" style="display:none;">
    <div class="dialog-content">
      <h3>Select Language</h3>
      <select id="langSelect">
        <option value="en-US">English (US)</option>
        <option value="vi-VN">Vietnamese</option>
        <option value="es-ES">Spanish</option>
        <option value="fr-FR">French</option>
        <option value="de-DE">German</option>
        <option value="zh-CN">Chinese (Mandarin)</option>
        <option value="ja-JP">Japanese</option>
        <option value="ko-KR">Korean</option>
      </select>
      <div class="dialog-actions" style="margin-top:10px; text-align:right;">
        <button onclick="confirmLanguage()">OK</button>
        <button onclick="closeLangDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      initRoulette({ hasDoubleZero: true, title: "American Roulette" });
    });
  </script>
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  onReady(function(){
    var b = document.getElementById('btnStatsHelp');
    var dlg = document.getElementById('helpDialog');
    var title = document.getElementById('helpTitle');
    var body = document.getElementById('helpBody');
    if(b && dlg && dlg.show){
      b.addEventListener('click', function(){
        if(title) title.textContent = 'Statistics';
        if(body) body.innerHTML = '<p>This section summarizes your recent spins.</p><ul style="text-align:left"><li><b>Pairs</b>: red/black, even/odd, low/high</li><li><b>Dozens & Columns</b></li><li><b>Streaks</b>: current and longest</li><li><b>Number heatmap</b>: frequency of exact numbers</li></ul>';
        dlg.show();
      });
    }
  });
})();

// Text size button controls
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  onReady(function(){
    const slider = document.getElementById('textScale');
    const decreaseBtn = document.getElementById('btnTextSizeDown');
    const increaseBtn = document.getElementById('btnTextSizeUp');
    
    if (slider && decreaseBtn && increaseBtn) {
      decreaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(slider.value);
        const newValue = Math.max(parseInt(slider.min), currentValue - 5);
        slider.value = newValue;
        slider.dispatchEvent(new Event('input'));
      });
      
      increaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(slider.value);
        const newValue = Math.min(parseInt(slider.max), currentValue + 5);
        slider.value = newValue;
        slider.dispatchEvent(new Event('input'));
      });
    }
  });
})();
</script>

<script>
// Direct sign out functionality to ensure it works
document.addEventListener('DOMContentLoaded', function() {
  const signOutButtons = document.querySelectorAll('#btnSignOut');
  console.log('Found sign out buttons:', signOutButtons.length);
  
  signOutButtons.forEach((button, index) => {
    console.log('Setting up sign out for button', index);
    button.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Sign out button clicked');
      
      // Simple redirect to signin page
      window.location.href = 'signin.html';
    });
  });
});
</script>
</body>
</html>
